# Compile Process

NominalScript's transpiler/compiler has 3 passes:
- **Declaration pass:** Resolve all imports and declarations, then generate an export map. Importantly, this allows hoisted declarations to be forward referenced; and the generated export map is enough to compile dependencies, so a file that is only transitively compiled may only go through this pass
- **Main pass:** traverse the entire program: check types based on inference rules plus those assigned via declaration, and simultaneously generate scopes to lookup values and do basic control-flow / data-flow analysis. Typechecking is done by assigning expressions **assigned** (in), **required** (in), and **runtime-required** (also in but looser) types: e.g. `2` is assigned `Natural`; `f(a, b)` looks up `f`'s assigned type, (assuming it's a function) requires `a` and `b` to be the parameter types, and assigns the entire expression `f(a, b)` the return type; and runtime-required types are assigned to wrapped expressions. Note that not all expressions will get assigned or required types: specifically, untyped expressions (like an imported identifier without a type annotation) have no assigned types and generate no required types. This pass also removes nominal type declarations and annotations from the AST, not only because they will not be in the output but because we want to track which ones are unhandled for the "no nominal annotations" pass.
- **Type-checking pass:** Checks that every expression with a required or runtime-required type has a corresponding assigned type. The difference between required and runtime-required types is that expressions with a required type **must** have an assigned type which is a subtype, and expressions with a runtime-required type must **cannot have an assigned type which is disjoint (not a subtype or supertype, even `Any` is OK)**. Runtime guards are inserted for runtime-required expressions whose assigned type is not a subtype (if the expression isn't a variable it is also assigned to one so that it isn't recomputed). We also check some types during the main pass, and this may be shifted into the main pass (type-check a nice once it has assigned and required type) or vice versa (add both assigned and required types at the same time, possibly implement new assigned/required classes), but maybe not (since we can just move diagnostic reporting)
- **No nominal annotations pass:** Checks that there are no remaining (unhandled) nominal annotations.

WIP